---
title: "MetaboVariation"
output: rmarkdown::html_vignette
always_allow_html: true
vignette: >
  %\VignetteIndexEntry{MetaboVariation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=8, fig.height=6) 
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r setup,results="hide"}
library(MetaboVariation)
library(future)
library(rstan)
library(brms)
library(plotly)
library(readxl)
```

# Introduction

## Background

Most metabolomic bio marker research so far has concentrated on disease bio markers discovered
by comparing patients with the illness to matched controls. This method has been demonstrated
to be helpful in the diagnosis of diseases. However, it has had only a limited impact on the
early detection of disease or metabolic dysfunction bio markers.\newline

The objective of the "MetaboVariation" is to develop a methodology for identifying individuals with significant variation in their metabolite levels and present the result in an understandable manner. Bayesian generalised linear model (BGLM) is used to identify individuals with significant variation in the metabolite levels. The package is built on the function *brm* from package *brms* that fits Bayesian framework using STAN. MetaboVariation model include covariates present in the data and learns the intra-individual variation of individuals using repeated measures. The model provides a posterior predictive distribution of metabolite levels at the individual level, that is used to identify individuals with actual metabolite level outside the 95% central credible interval at one time point; thus flagging the individuals.

This document gives a quick tour of MetaboVariation functionalities. It was written in R Markdown, using the *knitr* package for production. See help (package="MetaboVariation") for further details and references provided by citation("MetaboVariation").


# Walkthrough

## Prerequisite packages

Before we start the MetaboVariation walk through, the user should have working R software environment installed on their machine. The MetaboVariaton package has following dependencies and will also be installed along with the package if not already installed on the machine.

*  brms
*  circlize
*  ComplexHeatmap
*  doParallel
*  dplyr
*  foreach
*  future
*  grid
*  magrittr
*  parallel
*  plotly
*  reshape2
*  rstan
*  scales
*  stringr
*  readxl
*  tidyr
*  ggplot2

## Simulated data

"metabol.data" is a dataset that mimics the real life situation of how metabolomic data are stored in most cases. It is randomly created dataset that contains metabolites levels of 3 metabolites for 164 individuals taken on four different time points. Sex, Age and BMI are also recorded for these individuals in the data. 

Some data pre-processing is also done on the data such as the "Subject_id" and "SexM.1F.2" are transformed to factor columns. The names of covariates column and subject_id are stored in a variable for further use.

```{r data}
data(metabol.data)
colnames(metabol.data)
metabol.data$Individual_id = as.factor(metabol.data$Individual_id)
metabol.data$SexM.1F.2 = as.factor(metabol.data$SexM.1F.2)
covariates = c("SexM.1F.2","Age","BMI")
individual_id = "Individual_id"

```

## Extracting unique metabolite names

To identify unique metabolites that are present in the data, the function "getmetabolites" reads the list of column names that contains metabolite values and will provide a list of unique metabolite  after removing the timepoint from the column names. For proper result, the user should not pass any unnecessary column (any column that contains a covariate or subject_id information) to the function. The function will return a list containing the names of unique metabolites.

```{r getmetabolites}
metabolite_list = colnames(metabol.data)[5:length(colnames(metabol.data))]
metabolites = getmetabolites(list = metabolite_list)
metabolites
```

## Understanding the distribution of metabolites

To understand the distribution of the metabolite across timepoint before analysis, user can plot the distribution  of the metabolite for each timepoint using the function "plotMetabolite". The user can pass either a single or multiple metabolite to the function to get plots for every metabolite passed.

```{r plotMetabolite1}
plotMetabolite(data = metabol.data,metabolite = metabolites[1])
```


## Modelling the data to flag individuals

The main function "MetaboVariation" performs the modelling. The fitting of the model and the predicting both happens in this function itself.
The function models a Bayesian generalised linear model (BGLM) to identify individuals with variations in their metabolite levels using repeated measurements. The function needs the data along with the names of covariates column (if any) and subject id column to understand data. It can work with single metabolite value or multiple values of metabolites. 

```{r MetaboVariation1,results="hide"}
# save_brms_model = FALSE  It will not save the bayesian model developed 
# during processing. 
# full_posterior = FALSE It will not save the whole predicted posterior 
# distribution that we got during predicting stage.

model = MetaboVariation(data = metabol.data, individual_ids = individual_id,
          metabolite = metabolites[1:3],covariates = covariates,
          save_brms_model = FALSE,full_posterior = FALSE)# full_posterior
```

When multiple metabolites are passed to the function, it contains results for every metabolite as a list while each metabolite contains the following values.

*  significant_covariates
*  result
*  warmup
*  iterations
*  Rhat
*  metabolite
*  full_posterior(optional output)

See *?MetaboVariation* for further details about the function.

```{r MetaboVariation2}
names(model)
```

```{r MetaboVariation3}
names(model$metabolA)
```


## Plotting the results

After modelling, "plot" helps in visualization of the results. It can show the results in three format i.e. circos plot, number of individual counts per timepoint for each metabolite or metabolites count for each individual. 

* "circos" plot will show 95% credible interval of predicted posterior distribution for all the timepoints and if the actual value is outside the interval, the individual will be flagged. 
* "metabolites_count" plot will show how many individuals are flagged in each timepoint for every metabolite present in the "MetaboVariation" object.


```{r plot}
# type = "circos", "metabolites_count", "subject_count"
# timepoints = NULL/ vector Either all the timepoints are plotted in 
# the plots or a list of numeric vectors are plotted in the plot

plot(x = model,type = "circos")

plot(x= model$metabolA,type = "circos",timepoints = c(1,2,3))

plot(x = model, type = "metabolites_count")

```

## List of flagged individuals

After modelling, to get a list of individuals that have been flagged in single metabolite, you can use the function "flaggedIndividuals".
The function will give a list of individuals that have been flagged by the model and will provide covariate information and the metabolite levels for the all timepoints as well. 

```{r}
flaggedIndividuals(model$metabolA, data = metabol.data,individual_id = individual_id)
```

In case the model contains multiple metabolites, the function will return the list of individuals along with their covariates details. To get number of individuals that have been flagged in at least "n" metabolites, you can set the threshold to "n".

```{r}
flaggedIndividuals(model, data = metabol.data, individual_id = individual_id, threshold = 2)
```
