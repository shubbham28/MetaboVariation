---
title: "MetaboVariation"
output: 
  rmarkdown::html_vignette:
    toc: true
always_allow_html: true
vignette: >
  %\VignetteIndexEntry{MetaboVariation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=8, fig.height=6) 
#knitr::opts_chunk$set(eval = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r setup,results="hide",echo=FALSE}
library(MetaboVariation)
library(future)
library(rstan)
library(brms)
library(plotly)
library(readxl)
```

# Introduction

Most metabolomic biomarker research concentrates on disease biomarkers discovered
by comparing patients with the illness to matched controls. This method has been demonstrated
to be helpful in the diagnosis of diseases. However, it has had only a limited impact on the
early detection of disease or metabolic dysfunction biomarkers.\newline

The objective of the __MetaboVariation__ package is to develop a methodology for identifying individuals with significant
variation in their metabolite levels using repeated measures. A second objective was to develop options for visualisation of the results. 

Bayesian generalised linear models (BGLM) are used to identify individuals with significant variation in their metabolite levels. The package is built on the function [brm](https://www.rdocumentation.org/packages/brms/versions/2.17.0/topics/brm) from package [brms](https://cran.r-project.org/web/packages/brms/index.html) [[1][References]] that fits the model using STAN. The __MetaboVariation__ model can include covariates and learns the intra-individual variation in metabolite levels using repeated measures. Posterior predictive distributions of metabolite levels at the individual level are provided. These are used to identify individuals with observed metabolite level outside the 95% central credible interval at one time point; such individuals are flagged.

This document gives a quick tour of __MetaboVariation__ functionalities. See help `(package = MetaboVariation)` for further details and references available via `citation("MetaboVariation")`.


# Walk through

## Prerequisite packages

Before we start the __MetaboVariation__ walk through, the user should have the R software environment installed on their machine. The __MetaboVariaton__ package has the following dependencies which will be installed along with the package if not already installed on the machine.

*  brms, circlize, ComplexHeatmap, doParallel, dplyr, foreach, future, ggplot2, grid, magrittr, parallel, plotly, reshape2, rstan, scales, stringr, readxl, tidyr 

## Simulated data

The object `metabol.data` is a simulated dataset that contains metabolite levels of 3 metabolites for 164 individuals measured at four different time points. The covariates sex, age and BMI are also available for these individuals. 


```{r data}
data(metabol.data)
colnames(metabol.data)
```

The subject id of individuals is stored in column "Individual_id" while information of sex, age, and BMI are stored in "SexM.1F.2", "Age", and "BMI" respectively. The column name "metabol**X**_**Y**" represent metabolite level of metabolite **X** at time point **Y**.

Some data pre-processing is done on the "Individual_id" and "SexM.1F.2" are transformed to factor. The name of covariate columns and subject_id are stored in a different variable for further use.

```{r data1}
metabol.data$Individual_id = as.factor(metabol.data$Individual_id)
metabol.data$SexM.1F.2 = as.factor(metabol.data$SexM.1F.2)
covariates = c("SexM.1F.2","Age","BMI")
individual_id = "Individual_id"

```

## Extracting metabolite names

To identify  metabolites that are present in the data, the function `getmetabolites` reads the name of columns that contain metabolite values and provides a list of unique metabolites  after removing the timepoint from the column names. The user should not pass any unnecessary column names (any column names that relate to covariate or subject_id information) to the function. The function will return a vector containing the names of unique metabolites.

```{r getmetabolites}
metabolite_list = colnames(metabol.data)[5:length(colnames(metabol.data))]
metabolites = getmetabolites(list = metabolite_list)
metabolites
```

## Visualising the distribution of metabolites

The user can plot the distributions of metabolites for each timepoint using the function `plotMetabolite`. The user can pass either a single metabolite or multiple metabolites to the function.

```{r plotMetabolite1}
plotMetabolite(data = metabol.data,metabolite = metabolites[1],main="Distribution of metabolA")
```


## Modelling the data to flag individuals

The main function __MetaboVariation__ performs the modelling. The function uses a Bayesian generalised linear model (BGLM) to identify individuals with notable variations in their metabolite levels using repeated measurements. As arguments, the function requires the data along with the names of covariate columns (if any) and the subject id column. The function can work with a single metabolite or multiple metabolites. The BGLM is a statistical model that is not necessary for the user. Hence, it is not stored in memory, however, a user can store the model by `save_brms_model = TRUE`. 

To find the individuals with notable variation BGLM calculate the posterior predictive distribution for every individual at each time point. The function checks if the observed value of the individual is outside the central credible interval, if so, the individual is flagged. The range of central credible interval is set by `cutoff`. The function returns the summarised results that contains the credible interval and whether the indivdual is flagged or not. To save the complete posterior predictive distribution of every individual across each time point, set `full_posterior = TRUE`.

```{r MetaboVariation1,results="hide"}
model = MetaboVariation(data = metabol.data, individual_ids = individual_id,
          metabolite = metabolites[1:3],covariates = covariates,
          save_brms_model = FALSE,full_posterior = FALSE,cutoff=95)
```

When multiple metabolites are passed to the function, it contains results for every metabolite as a list while each metabolite contains the following values.

*  significant_covariates - a list of covariates that has significant link with the metabolite levels in individuals.
*  result - A summarized result for the posterior predictive distribution of the cohort. It contains the mean, \code{cutoff}% credible interval range, tails of the credible interval and the original value of the individual for that timepoint. It also has a flag value that shows whether the original value lies within the credible interval or not.
*  warmup - Number of total warmup iterations per chain.
*  iter - Number of total iterations per chain used for modelling.
*  Rhat - Rhat refers to the potential scale reduction statistic, also known as the Gelman-Rubin statistic. Thus, it measures the extent to which chains are converging. The further the value of the statistic from 1, the worse. Model is considered good if the value lies between 0.9 and 1.05.
*  metabolite - Contains the name of metabolite.
*  full_posterior - It contains the full posterior predictive distribution of the data.

See **?MetaboVariation** for further details about the function.

```{r MetaboVariation2}
names(model)
```

```{r MetaboVariation3}
names(model$metabolA)
```

## Plotting the results

After modelling, the function plot `plot` visualizes the results. It can show the results in two format i.e. a circos plot, the number of individuals per timepoint for each metabolite. 

* The `circos` plot shows the central credible interval of posterior predictive distribution for all the timepoints. If the observed value is outside this interval, the individual will be flagged. 
* The `metabolites_count` plot shows how many individuals are flagged in each timepoint for every metabolite present in the __MetaboVariation__ object.


```{r plot}
plot(x = model$metabolA)
```

The figure shows circos plot for Metabol\_A. The outer circle shows the individual’s label while each inner circle represents a time point. The length of a bar represents the  width of the 95\% posterior predictive interval and a black bar indicates that a particular individual has been flagged.

```{r plot1}
# User can change the plot type using the argument `type`.
# User can select time points to plot instead of plotting all of them.
plot(x = model, type = "metabolites_count",timepoints = c(1,2,3))
```

## List of flagged individuals

After modelling, to obtain a list of individuals that have been flagged for a single metabolite, the user can employ the function `flaggedIndividuals`.
The function provides a dataframe of individuals that have been flagged by the model as well as metabolite levels for all timepoints. 

```{r}
flaggedIndividuals(model$metabolA, data = metabol.data,individual_id = individual_id)
```

In the case of multiple metabolites, the function returns the dataframe of individuals along with the count of how many times they have been flagged in those metabolites. To obtain the number of individuals that have been flagged in at least __p__ metabolites, the threshold argumetnt should be set to __p__.

```{r}
flaggedIndividuals(model, data = metabol.data, individual_id = individual_id, threshold = 2)
```


# References

[1] Paul-Christian Bürkner (2017). brms: An R Package for Bayesian Multilevel Models Using Stan. Journal of Statistical Software, 80(1), 1-28. doi:10.18637/jss.v080.i01
